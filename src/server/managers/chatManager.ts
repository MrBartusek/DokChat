import db from '../db';
import sql from 'sql-template-strings';
import { Chat, ChatParticipant } from '../../types/common';
import Utils from '../utils';
import { Request } from 'express';
import { Handshake } from 'socket.io/dist/socket';

export default class ChatManager {
	public static async getChat(req: Request | Handshake, chatId: string): Promise<Chat> {
		const chats = await db.query(sql`
			SELECT
				name, avatar, is_group as "isGroup"
			FROM
				chats
			WHERE id = $1
			LIMIT 1;
		`, [ chatId ]);
		if(chats.rowCount == 0) throw new Error('Chat with provided id was not found');
		const participants = await ChatManager.listParticipants(req, chatId);
		const [ avatar, name ] = await ChatManager.generateAvatarAndName(
			req,
			chatId,
			participants,
			chats.rows[0].isGroup,
			chats.rows[0].name,
			chats.rows[0].avatar
		);
		return {
			id: chatId,
			avatar: avatar,
			name: name,
			isGroup: chats.rows[0].isGroup
		};
	}

	public static async listParticipants(req: Request | Handshake, chatId: string): Promise<ChatParticipant[]> {
		const query = await db.query(sql`
			SELECT
				participants.id,
				user_id as "userId",
				username, tag
			FROM
				participants
			JOIN users ON users.id = user_id
			WHERE chat_id = $1;
		`, [ chatId ]);
		const result: ChatParticipant[] = [];
		for(const part of query.rows) {
			result.push({
				id: part.id,
				userId: part.userId,
				username: part.username,
				tag: part.tag,
				avatar: Utils.avatarUrl(req, part.userId)
			});
		}
		return result;
	}

	/**
	 * Get avatar and name of chat and generate default ones
	 * if they are missing
	 */
	public static async generateAvatarAndName(
		req: Request | Handshake,
		chatId: string,
		participants: ChatParticipant[],
		isGroup: boolean,
		rawName: string,
		rawAvatar: string
	): Promise<[string, string]> {
		if(isGroup) {
			const autoGeneratedName = participants.map(u => u.username).join(', ').substring(0, 32);
			return [
				rawAvatar || Utils.avatarUrl(req, chatId),
				rawName || autoGeneratedName
			];

		}
		else {
			const user = participants.find(u => u.userId != req.auth.id);
			return [
				rawAvatar || Utils.avatarUrl(req, user.userId),
				rawName || `${user.username}#${user.tag}`
			];

		}
	}
}
